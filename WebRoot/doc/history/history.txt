本文本文档用于记录在开发过程当中遇到的问题以及经验
1: 代码使用google code托管，所以需要拥有一个google的账号，并且保证能联网，然后请将你的账号告诉我，以便我为你添加权限。
2: 一般我会为你设置最高权限，然后请使用https://redeem-point-system.googlecode.com/svn/trunk来checkout整个应用的代码。
3: 如果你要提交代码，那么请设置用户名为你的邮箱账号，密码请到http://code.google.com/hosting/settings页面去找，但是该页面时好时坏，所以请耐心。
4: 开发环境的搭配：
   1) Eclipse3.5(可选)
   2) Mysql 5.0(必须)
   3) SVN 1.6
   4) JDK 1.6(必须)
   5) Tomcat6.0(可选)
   
mysql 连接，显示中文方法
mysql --default-character-set=gbk -uuser -ppassword


开发历史/问题记录
2011/05/13
初始化所有基础文件，包括相关的jar包以及编码规范。

2011/05/15
与客户陈先生交谈，约定21号面谈。

2011/05/16
按钮权限的算法分析
1: 我目前是这样做的，但是觉得有一个缺陷：如果有意图的人员知道你的代码，可以不通过这个链接来访问action.或者这么说吧：本来有个超级权限的人，可以访问：XYZAction, 在他被取消这个权限之后，没有了指向XYZAction的连接，但是他可以通过在地址栏上直接键入http://wer.werw.werww/XYZAction.do?param1=***&param2=***这样来访问。


2: 给每个页面上的按钮加唯一标识符（唯一标识一般的方法是“模块名称+控件的ID”。）
必须注意直接从地址栏中访问的方式:
1): 禁止所有的jsp直接访问，改用action后台跳转方式
2): 过滤所有的action方式，然后去菜单数据库里面查该action是否存在，存在则跳转，否则不跳转。
 
3: Session被缓存的解决方法：
     1.重新调用原页面的时候在给页面传一个参数:    href="****.aspx?random()"

     2.HTML方法
        <HEAD>
        <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
        <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache">
        <META HTTP-EQUIV="Expires" CONTENT="0">
        </HEAD>

     3.Response.Buffer = true;
        Response.ExpiresAbsolute = System.DateTime.Now.AddSeconds(-1);
        Response.Expires = 0;
        Response.CacheControl = "no-cache";
        Response.AddHeader("Pragma", "No-Cache");

spring security3配置
http://www.docin.com/p-55317729.html
spring security3配置（例子）
http://www.blogjava.net/redhatlinux/archive/2008/08/20/223148.html
控制只允许一个用户登录一次
http://www.iteye.com/topic/823666

http://blog.csdn.net/wyfh2010/archive/2011/03/23/6269799.aspx


2011/05/19
基本完成页面级别的权限控制。
动态的刷新数据库，获取权限
http://old.family168.com/bbs/dv_rss.asp?s=xhtml&boardid=22&id=2033&page=1&star=1&count=11
http://old.family168.com/oa/springsecurity/html/ch207-resc.html
http://www.cnblogs.com/shitou/archive/2011/04/20/2022262.html

http://old.family168.com/bbs/dispbbs.asp?boardid=22&id=2033&page=&star=1
http://old.family168.com/bbs/dispbbs.asp?boardid=22&Id=589&page=3

http://code.google.com/p/family168/

http://www.gbsou.com/2009/10/14/1050.html


2011/05/20
完成刷新内存的功能，这个是手动刷新而不是自动刷新，当改变某个用户权限（角色）时刷新。
原因是：如果设置为自动刷新，那就只能是在用户请求页面的时候去刷新，这样每个用户去请求页面都刷新的话，可能导致性能等问题。

使用方法：在Spring Security的配置文件中增加resourceDetailsMonitor的配置。然后在对于的java文件中增加：
private ResourceDetailsMonitor resourceDetailsMonitor;并且加上get与set方法。然后调用它的refresh方法即可。

2011/05/21
目前现状：
更改某用户的角色之后，需要该用户重新登录才有效。
更改某角色的访问权限之后，无需用户重新登录即可生效。

2011/05/26
开始准备与Ext2.2.1的融合

使用方法: 在每个jsp页面的第二行，加入以下代码：<%@include file="/jsp/common/config.jsp" %>即可。

用户登录成功之后，存放在Session里面的数据:
9B8180A61C9E9C40FBACF656D2AEBB77
49143B00BBFF3900B83B544561F4EE88
{SPRING_SECURITY_CONTEXT=org.springframework.security.core.context.SecurityContextImpl@fff5afed: Authentication: org.springframework.security.authentication.UsernamePasswordAuthenticationToken@fff5afed: Principal: org.springframework.security.core.userdetails.User@36ebcb: Username: user; Password: [PROTECTED]; Enabled: true; AccountNonExpired: true; credentialsNonExpired: true; AccountNonLocked: true; Granted Authorities: 客户; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication.WebAuthenticationDetails@12afc: RemoteIpAddress: 127.0.0.1; SessionId: 451E60931A333F7B2BBB342925CEBA54; Granted Authorities: 客户, SPRING_SECURITY_LAST_USERNAME=user}
{userName=swpigris81, SPRING_SECURITY_CONTEXT=org.springframework.security.core.context.SecurityContextImpl@e1a14949: Authentication: org.springframework.security.authentication.UsernamePasswordAuthenticationToken@e1a14949: Principal: org.springframework.security.core.userdetails.User@83fa6aab: Username: swpigris81; Password: [PROTECTED]; Enabled: true; AccountNonExpired: true; credentialsNonExpired: true; AccountNonLocked: true; Granted Authorities: 1; Credentials: [PROTECTED]; Authenticated: true; Details: org.springframework.security.web.authentication.WebAuthenticationDetails@fffdaa08: RemoteIpAddress: 127.0.0.1; SessionId: 61E94EE294E2CFFFB57F95F1B0CC0F1D; Granted Authorities: 1, SPRING_SECURITY_LAST_USERNAME=swpigris81, roleId=1}
用户注销成功之后，Session里面没有数据.
但是Session到期之后，SpringSecurity并不会注销，当用户刷新的时候，会创建一个新的Session，该新建Session是旧Session的复制品。

2011/05/27
一个相当漂亮的网站：
http://www.vifir.com/my.ejf
http://www.gwt-ext.com/demo/

http://aariadne.com/accordion-preview/
http://topic.csdn.net/u/20091007/18/f3e6ffa3-b5f0-4c92-b3d9-bb2e6b1e5604.html
//Ext同步获取数据方式
var response = Ext.lib.Ajax.getConnectionObject().conn; response.open("GET", 'test.jsp',false);

ExtJS+Struts2+JSON生成“accordion”布局的树菜单
http://blog.csdn.net/leecho571/archive/2010/12/05/6056564.aspx
http://hi.baidu.com/fscai/blog/item/d8d3139ad12d2db3c8eaf462.html/cmtid/56f98fd23f7ba53f960a163d

2011/05/29
基本能形成accordion布局的菜单了，只是查询子菜单的时候是有点失误的，那个需要有访问权限才行。

2011/05/31
http://www.cnblogs.com/huazi4995/articles/1245150.html

JScript code Ext.BLANK_IMAGE_URL = 'js/ext/resources/images/default/s.gif'; Ext.onReady(function(){ var root = new Ext.tree.AsyncTreeNode({text:'【税务机关列表】'}); var tree = new Ext.tree.TreePanel({ region:'west', contentEl:'west-div', title:'【树列表】', split:true, width: 200, minSize: 175, maxSize: 400, autoScroll :true, expanded:true, collapsible: true, margins:'0 0 0 0', animate:true, waitMsg:"正在加载数据，稍等......", loader: new Ext.tree.TreeLoader({dataUrl: '/NewSMS/data.htm'}), loader: new Ext.tree.DWRTreeLoader({dataUrl:SwjgBus.getjsonTree}), proxy: new Ext.data.DWRProxy(SwjgBus.getjsonTree, true), // loader: new Ext.tree.TreeLoader({dwrCall:SwjgBus.getjsonTree}), root:root }); tree.on('click', function (node){ if(node.isLeaf()){ if( node.attributes.hrefTarget===undefined){ node.attributes.hrefTarget='#'; return; } try {Ext.get('center-iframe').dom.src = node.attributes.hrefTarget ; } catch(e){} } } , this, {stopEvent:true} );

http://ideapad.zol.com.cn/54/160_538775.html 

2011/06/05
已完成accordion树形结构的菜单了。并且完成了所有的非法菜单将显示“无权访问”的信息。
下一步的操作是将权限控制细化到按钮上（方法级的权限控制）

1)一个角色->多个菜单，一个菜单->多个按钮
2)一个角色->多个权限，一个权限->多个按钮

需要注意的是，当用户对某个菜单具备访问权限的时候，才能对该菜单下的按钮有访问权限。


2011/06/17
http://blog.csdn.net/guo583/archive/2011/05/12/6416007.aspx
http://blog.csdn.net/guo583/archive/2011/04/03/6299805.aspx
http://school.itzcn.com/video-vid-3037-spid-53.html
http://blog.csdn.net/ibm_hoojo/archive/2010/07/09/5722934.aspx
http://blog.sina.com.cn/s/blog_66ed53840100hbhs.html
http://blog.csdn.net/marksman_hawk/archive/2011/01/25/6162499.aspx

2011/06/18
每个菜单还有按钮需要显示
显示带checkBox的菜单树：
查询所有的树节点以及有权限的节点，然后手动的设置菜单树的选中状态。

2011/06/20
在Extjs中treepanel中树节点为checkbox类的节时，有时候我们需要用程序来设置他的选中和取消选中状态
var nodes=tree.getChecked(); 
if(nodes && nodes.length){
 for(var i=0;i<nodes.length;i++){
  //设置UI状态为未选中状态
  nodes[i].getUI().toggleCheck(false);
  //设置节点属性为未选中状态
  nodes[i].attributes.checked=false;
 }
}
这样通过获取已选择的节点，用程序取消选择状态
反之可以设置未选中节点选中状态

2011/06/21
mysql的字段名如果为保留字或者其他的如（PHONE.1）类型的，在查询的时候使用：select `PHONE.1` from table;
``:键盘1的左边（Esc按钮下面）

Hibernate生成动态语句SQL的开销很小，所以不会影响应用的运行性能。如果表中包含许多字段，建议把dynmaic-insert和dynmaic-update属性设置为true。
这样，在insert和update语句中就只包含需要插入或者更新的字段，这样可以节省数据库执行SQL语句的时间，从而提高应用的运行性能。

使用hibernate的update方法，会自动更新全部字段。

2011/06/22
授权角色菜单完成。
下一步，准备完成菜单的增删改查功能。

SELECT
menu_info.menu_id,
menu_info.menu_name,
menu_info.page_path,
menu_info.menu_level,
menu_info.parent_menu,
menu_info.is_leave,
(select menu.menu_name menuname from menu_info menu where menu_info.parent_menu = menu.menu_id)
FROM
menu_info

2011/06/23
http://hi.baidu.com/lvsiquan/blog/item/d46acc9797a83d7455fb96dc.html
http://hi.baidu.com/qethan/blog/item/fb6f3c18e596abe2e1fe0b04.html
http://hi.baidu.com/ybhanxiao/blog/item/63175789cce4e3be0e2444f9.html

2011/06/26
完成菜单的增删改
按钮的删
注意这些东西的改动，必须在事务提交之后进行刷新内存的操作，以便让修改的操作生效。

2011/06/30
自定义单元格css样式
http://www.huomo.cn/developer/article-4222.html
//更改行高
http://www.iteye.com/topic/165218

2010/07/01
今天是我的账目信息上线一周年纪念日哟！
只有通过解析当前tab的iframe页面的id来获取当前页面的url的ID了。

2010/07/02
新加入了首页不管是否登录都能看到。
对权限更加严格化，无权限的页面即便是刷新也将会返回首页。

2010/07/03
Hibernate 提供的JDBC的sql执行方法2种：
session.createSQLQuery(nativeSql).executeUpdate();
session.getConnection().createStatement().execute(sql); 

盐值加密：
密码{用户名}
admin{admin}

2010/07/09
完成权限部分的所有模块。

普通用户模块
1:用户初次进入本系统，需要注册。注册成功的话，系统将为该用户分配角色:"系统注册用户".
2:"系统注册用户",该角色是配置在/WEB-INF/service/applicationContext-action.xml文件中,修改之后,需要重启服务器否则不生效。
3:"系统注册用户",该角色也必须同时是存在数据库中角色信息表中的一条数据，否则该注册用户将不会被分配角色。需要系统管理员手动为其分配角色.
4:用户注册成功之后，系统将会自动为用户登录。无需用户手工登录。
5:用户登录成功之后，系统将在整个页面的左下方为该用户显示出有访问权限的菜单链接。
6:如发现菜单显示不完整或者其他问题，可以点击"刷新菜单"按钮，以刷新菜单

系统管理员
1:系统管理员拥有所有的访问权限。
2:系统管理员对以下信息作出修改之后，系统将会在后台进行刷新的操作，以便及时生效。
  1)添加/修改/删除用户信息
  2)添加/修改/删除角色信息
  3)添加/修改/删除菜单信息
  4)添加/修改/删除按钮信息
  5)添加/修改/删除用户的角色信息
  6)添加/修改/删除角色的访问权限信息
3:当管理员修改了某用户的角色之后，该用户需要重新登录才能生效。但是其能访问的权限则是即时生效。
4:权限组件之间的关联关系：
  1)一个用户只有一个角色信息
  2)一个角色信息有一个或多个菜单访问权限
  3)一个角色信息只有拥有某菜单的访问权限的情况下，才能拥有对该菜单下的按钮访问权限。
  4)一个菜单有一个或多个按钮
  5)一个角色信息如果有一个或多个菜单访问权限，则它拥有一个或多个该菜单下的按钮访问权限。
5:授权管理模块:
  1)模块页面分为两个个部分，上、下。下部分有两个tab页。
  2)上部分：上部分显示系统中已存在的角色信息。
  3)下部分：
    a:显示系统用户信息，当点击上部分的角色信息之后，将会显示该角色信息下的所有用户信息
    b:显示系统菜单信息，当点击上部分的角色信息之后，系统将勾选有权限的菜单节点。
  4)为用户授权：
  	a:点击上部分的角色信息，点击下部分用户信息列表上的"添加授权用户"按钮，在弹出框中选中需要授权的用户，点击"保存"即可，新授权的用户的角色信息将覆盖之前的角色信息。
  	b:点击上部分的角色信息，勾选菜单树，点击保存，即可为某角色分配最新的访问权限。
6:异常情况：
  1)用户访问未授权的菜单或者信息，系统将跳转到用户首页，并提示用户无权访问。
7:安装系统:(Windows操作系统可用)
  1)请首先保证计算机或者服务器上安装有MySql 5.0以上版本。
  2)请将程序中/WebRoot/doc/redeempoint.sql文件拷贝至计算机的任意位置，此处假设c:/
  3)请开启MySql服务。
  4)请打开一个命令窗口。开始->允许->cmd。快捷键：windows+R
  5)输入以下命令：mysql -uroot -proot  其中-u后面的是MySql数据库的用户名，-p后面的是该用户名对应的密码
  6)请确认数据库中不存在redeempoint数据库，若存在，请先删除该数据库。
  7)删除数据库的命令:drop database redeempoint。
  8)请创建数据库redeempoint。命令：create database redeempoint
  9)请使用当前数据库。命令: use redeempoint
  10)请输入以下命令，导入数据库文件。命令：source c:/redeempoint.sql (该文件就是第2步中提到的数据库文件)
  11)请将发布包放在Tomcat的webapp目录下，启动tomcat即可


2011/07/11
安装jQuery插件
http://www.cnblogs.com/shulin/archive/2010/08/09/1796146.html
240多个jQuery插件
http://www.iteye.com/topic/779476
JavaScript 範例
http://jsgears.com/forum-17-1.html
http://webdesignerwall.com/tutorials/jquery-tutorials-for-designers
jQuery+Json
http://www.itivy.com/jquery/archive/2011/6/23/how-jquery-parse-json-data.html
http://www.360doc.com/content/09/1125/18/109051_9737361.shtml
jQuery的json插件
https://github.com/douglascrockford/JSON-js
分页
http://www.cnblogs.com/szw/archive/2008/02/23/1078238.html
jQuery增删改查
http://www.cnblogs.com/cw_volcano/archive/2011/02/24/1964128.html
http://www.xpdesigner.com.cn/wordpress/?p=33
jQuery的grid插件
jqGrid
http://polaris.blog.51cto.com/1146394/259336
http://www.beijixing001.com/?p=406
http://www.trirand.com/blog/
http://trirand.com/blog/jqgrid/jqgrid.html
DataTables
http://www.51ascx.com/212.html
http://www.datatables.net/

jQuery系列文章
http://www.helloweba.com/blog.html?cata=5&p=1
jQuery图表生成组件
http://www.helloweba.com/view-blog-40.html

2011/07/13
nutz在线API
http://build.sunfarms.net/nutz/lastest/api/
发现jQuery的$.ajax异步请求数据的success回调方法的调用方法：在返回的数据格式必须是带有双引号的json数据(如果dataType='json'的话)
如：{"success":"true","totalCount":"34"}.其中的success不是必须的。如果没有双引号，则success回调方法不执行。
这一点与ExtJs不一样。ExtJs不用必须是双引号。

如果这样的话，需要在返回Json字符串之前加上nutz的配置,代码如下：
//设置json字符串的格式
JsonFormat jf = new JsonFormat();
//为属性名加上引号
jf.setQuoteName(true);

更换了nutZ的最新版本，但是发现其中的中文是乱码，真是晕啊。
jQuery分页插件
http://linapex.blog.163.com/blog/static/1892375162011523101954885/

2011/07/15
jQuery Easy UI(类似ExtJS的各个组件)
http://www.jeasyui.com/index.php

2011/07/18
图片缩放插件：PopBox

2011/07/22
jQuery 图片放大插件
http://addyosmani.com/blog/zoomer-gallery-a-jquery-plugin-for-displaying-images-with-flash-like-zooming-effects/
http://www.dynamicdrive.com/dynamicindex4/featuredzoomer.htm

http://www.111cn.net/js_a/75/b77e0732ed0bced05217062ccf136f9c.htm

2011/08/03
ssh进行整合，并且action交给spring来管理的话，则必须配置scope="prototype"，否则默认会采用单例模式，会有许多问题的。
参考：http://www.iteye.com/topic/898425
struts2+hibernate+spring配置文件:
默认是scope="singleton",唯一的.
scope="prototype"的作用：会在该类型的对象被请求时创建一个新的action对象。如果没有配置scope=prototype则添加的时候不会新建一个action，他任然会保留上次访问的过记录的信息。
特别的是在上传文件的时候，如果采用默认的情况，则当再次访问同一个action的时候，系统会记录下来你最后一次上传文件的名字。这样会导致文件无法更新。


2011/08/08
搞定Struts2的文件上传，以及文件上传失败或者发生错误时的错误提示。
Struts2有两个级别的错误提示：actionErrors, feildErrors. 获取方法：
<code>
String error = "";
try{
	Object obj = request.getAttribute("struts.valueStack");
	ValueStack vs = (ValueStack) obj;
	
	ArrayList or1 = (ArrayList)vs.findValue("actionErrors");
	if(or1!=null && or1.size()>0){
		System.out.println("========================="+or1.get(0)+"==========================");
	}
	Map o = (Map)vs.findValue("fieldErrors");
	if(o != null && o.size() > 0){
		ArrayList or = (ArrayList)o.get("giftImage");
		if(or != null && or.size() > 0){
			error = String.valueOf(or.get(0));
		}
	}
}catch(Exception e){
    error = e.getMessage();
	e.printStackTrace();
}
</code>
可以在error.jsp上完成以上代码

actionErrors级别的错误是发生在struts.xml文件中
feiltErrors级别错误是发生在各个struts子配置文件中,如：com/integral/exchange/gifts/config/gift.xml

具体，请参考com/integral/exchange/gifts/config/gift.xml礼品管理中的增加/编辑礼品信息功能

2011/08/11
创建java doc API的方法：
右键->export->java doc
为避免乱码或者编码问题的，输入下面的参数即可：
-encoding utf-8 -charset utf-8

aut+d 模拟交易软件
http://www.autd.cc/jiaoyi.html
壁纸下载
http://u.115.com/file/clfd5ybi

2011/08/21
SQL语句的优化，使用EXPLAIN语句能查询该查询语句的运行状态
使用方法，将EXPLAIN放在sql语句之前即可。
为codeListData表增加两个索引，为查询提速

#EXPLAIN
SELECT 
child.dataid, 
child.codeid, 
(
SELECT codelist.codename
FROM point_system_codelist AS codelist
WHERE child.codeid = codelist.codeid) codename,
child.datakey, 
child.datavalue, child.parentdatakey, 
parent.datavalue AS parentvalue, child.remark
FROM point_system_codelist_data AS parent
JOIN
point_system_codelist_data AS child ON child.parentdatakey = parent.datakey UNION ALL
SELECT 
child.dataid, child.codeid,
(
SELECT codelist.codename
FROM point_system_codelist AS codelist
WHERE child.codeid = codelist.codeid) codename,
child.datakey,child.datavalue, child.parentdatakey, NULL AS parentvalue, child.remark
FROM point_system_codelist_data child
WHERE child.parentdatakey IS NULL
ORDER BY codeid DESC, dataid DESC